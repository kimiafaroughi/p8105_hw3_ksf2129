---
title: "p8105_hw3_ksf2129"
author: "Kimia Faroughi"
date: "2025-10-08"
output: github_document
---

## Problem 1

**Load the dataset**

```{r setup, message = FALSE}
library(tidyverse)
library(p8105.datasets)
library(patchwork)
library(ggridges)
data("instacart")

#global ggplot settings
#knitr::opts_chunk$set(
  #fig.width = 8,
  #fig.asp = .6,
  #out.width = "90%"
#)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```

There are `r nrow(instacart)` rows (observations) and `r ncol(instacart)` columns (variables) in the `instacart` dataset. Each row in the dataset is a unique product from an order from instacart. Variable names in this dataset include: `r names(instacart)`. Some variables of note are `product_id` (the product identifier), `user_id` (the customer identifier), `product_name` (name of the product ordered), `aisle` (name of the aisle the product is in), and `department` (name of the department the product is in). For example, for the product `49302` and customer `112108`, the product ordered was `Bulgarian Yogurt`, which was in the `dairy eggs` department in the `yogurt` aisle.

**Explore dataset further**

There are `r instacart |> select(aisle) |> unique() |> nrow()` different (unique) aisles in the dataset. 

```{r}
instacart |> 
  group_by(aisle) |> 
  summarize(
    n = n() #gives number of obs
  ) |> 
  arrange(desc(n))
```

The most items are ordered from the fresh vegetables and fresh fruits aisles, followed by the packaged vegetables fruits, yogurt, and packaged cheese aisles.

**Plot showing the number of items ordered in each aisle, limited to aisles with more than 10000 items ordered:**

```{r, fig.height = 8, fig.width = 12}
instacart |> 
  group_by(aisle) |> 
  summarize(
    n = n()
  ) |> 
  filter(n > 10000) |> 
  arrange(desc(n)) |> 
  mutate(aisle = fct_inorder(aisle)) |> #put aisle in order of how it appears in data
  ggplot(aes(x = aisle, y = n)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  labs(
    x = "Aisle",
    y = "Number of Items",
    title = "Number of Items Ordered in Each Aisle"
  )
```

**Table showing 3 most popular items per aisle:**

```{r}
instacart |> 
  filter(aisle %in% c("baking ingredients", "dog food care", "packaged vegetables fruits")) |> 
  group_by(aisle, product_name) |> 
  summarize(
    times_ordered = n()
  ) |>
  arrange(aisle, desc(times_ordered)) |> 
  mutate(product_rank = min_rank(-times_ordered)) |> #ranks by max amount
  filter(product_rank < 4) |> 
  select(-product_rank) |> 
  knitr::kable()
```

**Table showing mean hour of day at which pink lady apples and coffee ice cream are ordered on each day of the week:**

```{r}
instacart |> 
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) |> 
  group_by(product_name, order_dow) |> 
  summarize(mean_hour = mean(order_hour_of_day)) |> 
  pivot_wider(
    names_from = product_name,
    values_from = mean_hour
  ) |> 
  knitr::kable(digits = 2)
```

## Problem 2

**Clean and tidy the Zillow datasets**

```{r}
zip_codes_df =
  read_csv("zillow_data/Zip Codes.csv") |> 
  janitor::clean_names() |> 
  relocate(zip_code, county, neighborhood) #puts zip code, county, and neighborhood at the front

zip_zori_df =
  read_csv("zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") |> 
  janitor::clean_names() |> 
  pivot_longer(
    cols = x2015_01_31:x2024_08_31,
    names_to = "date",
    values_to = "rent",
    names_prefix = "x" #deletes prefix string from each name value
  ) |> #put vars representing each date into its own var with another var corresponding to rent prices
  separate(
    date, into = c("year", "month", "day"), sep = "_", convert = TRUE
  ) |> #separate date into year, month, and day
  rename(zip_code = region_name, county = county_name) |> 
  mutate(county = str_remove(county, " County")) |> #deletes suffix string from each value
  relocate(zip_code, county, month, day, year, rent) #puts zip code, county, month, day, year, and rent at the front

#merge datasets
zillow_tidy =
  full_join(zip_zori_df, zip_codes_df, by = c("zip_code", "county")) |> 
  relocate(zip_code, neighborhood, county, month, day, year, rent) |> 
  mutate(zip_code = as.character(zip_code)) #convert zip code to character var
```

`r zillow_tidy |> group_by(zip_code) |> summarize(count = n()) |> filter(count == 116) |> unique() |> nrow()` zip codes are observed 116 times. `r zillow_tidy |> group_by(zip_code) |> summarize(count = n()) |> filter(count < 10) |> unique() |> nrow()` zip codes are observed less than 10 times. 

Some zip codes are observed each month and others are observed rarely because the full dataset combines both the dataset containing the neighborhood information for each zip code and the dataset containing the rental price information for each zip code which is collected per month. Therefore, some zip codes from the neighborhood information dataset are not included in the rental price dataset, and appear in the full dataset only once, whereas those only in the rental price dataset appear 116 times for each month the data was collected. 

**Table showing average rental price in each borough and year:**

```{r}
#add borough var
zillow_tidy = 
  zillow_tidy |> 
    mutate(
      borough = case_match(
        county,
        "Queens" ~ "Queens",
        "Kings" ~ "Brooklyn",
        "Bronx" ~ "Bronx",
        "New York" ~ "Manhattan",
        "Richmond" ~ "Staten Island")
    ) 

#create table
zillow_tidy |> 
  group_by(borough, year) |> 
  summarize(mean_rent = mean(rent, na.rm = TRUE)) |> 
  pivot_wider(
    names_from = borough,
    values_from = mean_rent
  ) |>
  drop_na(year) |> 
  knitr::kable(digits = 2)
```

This table shows that in Brooklyn, Manhattan, and Queens, average rental prices per year increased from 2015 until 2020, when they dropped, and then continued increasing from 2021 onward. In the Bronx, prices have steadily increased through 2015-2024. In Staten Island there is no data on rental prices until 2020, but from 2020-2024, prices have also steadily increased. 

**Plot showing NYC rental prices within zip codes for all available years, comparing across boroughs:**

```{r, fig.height = 8, fig.width = 15}
prices_per_year = 
  zillow_tidy |> 
  drop_na(year, rent) |> 
  ggplot(aes(x = rent, y = factor(year), fill = borough)) +
  geom_density_ridges(alpha = 0.5) +
  scale_x_continuous(
    breaks = c(0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000)) +
  labs(
    x = "Rent Price within Zip Codes",
    y = "Year",
    title = "NYC Rental Prices within Zip Codes for All Available Years",
    fill = "Borough"
  )

prices_per_year
```

This plot shows that, in general, rent prices for Manhattan are generally higher than the other boroughs. Additionally, rent prices in Brooklyn noticeably dropped in 2020, steadily increasing since then. There is a similar, but less noticeable, decrease in rent in 2020 in Queens and Manhattan. After dropping in 2016, rent prices have been steadily increasing per year in the Bronx, which also generally has the lowest rent prices out of all the boroughs. Rent has been similarly increasing per year in Staten Island since 2020, when data is first available. 

**Plot of the distribution of ZIP-code-level rental prices across boroughs over each month in 2023:**

```{r, fig.height = 8, fig.width = 15}
prices_per_month =
  zillow_tidy |> 
  filter(year == 2023) |> 
  group_by(zip_code, month) |> 
  mutate(
    mean_rent = mean(rent, na.rm = TRUE)
  ) |>
  drop_na(mean_rent) |> 
  ggplot(aes(x = mean_rent, y = factor(month), fill = borough)) +
  geom_density_ridges(alpha = 0.3) +
  scale_x_continuous(
    breaks = c(0, 1000, 2000, 3000, 4000, 5000, 6000, 7000, 8000)) +
  labs(
    x = "Mean Rent Price within Zip Codes",
    y = "Month",
    title = "NYC Rental Prices within Zip Codes Over Each Month in 2023",
    fill = "Borough"
  )

prices_per_month
```

This plot shows that the distribution of mean rent price within zip codes in the Bronx, Queens, and Staten Island are relatively centered around the same values, which do not drastically change throughout the months in 2023. Average prices in Manhattan are noticeably higher than the rest of the boroughs throughout all months of 2023, with a slight increase in prices going into the summer months, followed by a decrease going into the winter months. Brooklyn shows a varied distribution of average rent prices across all months, with a less discernible peak compared to other boroughs, but one which appears consistent throughout all months. Queens and Manhattan similarly have wider distributions, but the concentrations of average rent prices within zip codes are more noticeable. 

**Combining the two plots above**

```{r, fig.height = 8, fig.width = 15}
#patchwork
combined_prices = (prices_per_year + prices_per_month)
combined_prices

#save
ggsave("results/combined_prices.pdf", combined_prices, 
       width = 15, height = 8) #width and height in inches
```